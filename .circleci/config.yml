# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  build:
    filters:
      branches:
        only:
          - master
    docker:
      - image: circleci/node:10.20.1
      - image: circleci/mongo:3.6.3
        port: 27017:27017
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: yarn install
      - run:
          name: Test Application
          command: yarn test
          environment:
            baseURL: http://localhost:3000/api/
            cookieKey: eat-me-pfftt
            LOCALHOST: http://localhost:3000
            DATABASE: iceteam-test-database
            IMAGEAPI: http://localhost:4000
            NODE_ENV: testing
            PORT: 5001
            inTesting: true
      - run:
          name: Redeploy Application
          command: ssh -o "StrictHostKeyChecking no" -v $DROPLET_USER@$DROPLET_IP "cd /var/www/sjsiceteam.com/app; git pull origin master; yarn install; yarn test; yarn build; pm2 restart 0"
